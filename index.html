<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Budget">
  <title>Monthly Budget</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Lucide icons as inline SVGs
    const DollarSign = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
    );
    
    const Plus = ({size = 24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    
    const X = ({size = 24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    
    const Archive = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="21 8 21 21 3 21 3 8"></polyline>
        <rect x="1" y="3" width="22" height="5"></rect>
        <line x1="10" y1="12" x2="14" y2="12"></line>
      </svg>
    );
    
    const ChevronLeft = ({size = 24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronDown = ({size = 24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const ChevronUp = ({size = 24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    );

    function BudgetApp() {
      const [view, setView] = useState('current');
      const [income, setIncome] = useState('');
      const [expenses, setExpenses] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [archivedMonths, setArchivedMonths] = useState([]);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [showTransactionModal, setShowTransactionModal] = useState(false);
      const [expensesExpanded, setExpensesExpanded] = useState(true);
      const [expandedWeeks, setExpandedWeeks] = useState({});
      const [newExpense, setNewExpense] = useState({ name: '', amount: '' });
      const [newTransaction, setNewTransaction] = useState({ description: '', amount: '', type: 'groceries' });

      useEffect(() => {
        loadData();
        checkAndArchiveIfNeeded();
      }, []);

      const getCurrentPeriod = () => {
        const now = new Date();
        const day = now.getDate();
        const month = now.getMonth();
        const year = now.getFullYear();
        
        if (day >= 27) {
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          return `${year}-${String(month + 1).padStart(2, '0')}-27 to ${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-26`;
        } else {
          const prevMonth = month === 0 ? 11 : month - 1;
          const prevYear = month === 0 ? year - 1 : year;
          return `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-27 to ${year}-${String(month + 1).padStart(2, '0')}-26`;
        }
      };

      const getMondayOfWeek = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
      };

      const getWeekLabel = (monday) => {
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return `${monday.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})} - ${sunday.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})}`;
      };

      const isWeekComplete = (monday) => {
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return new Date() > sunday;
      };

      const groupTransactionsByWeek = () => {
        const weeks = {};
        
        transactions.forEach(transaction => {
          const transDate = new Date(transaction.date.split('/').reverse().join('-'));
          const monday = getMondayOfWeek(transDate);
          const weekKey = monday.toISOString().split('T')[0];
          
          if (!weeks[weekKey]) {
            weeks[weekKey] = {
              monday: monday,
              label: getWeekLabel(monday),
              transactions: [],
              isComplete: isWeekComplete(monday)
            };
          }
          
          weeks[weekKey].transactions.push(transaction);
        });

        return Object.entries(weeks).sort((a, b) => new Date(b[0]) - new Date(a[0]));
      };

      const loadData = () => {
        const currentPeriod = getCurrentPeriod();
        const savedIncome = localStorage.getItem('budget:income');
        const savedExpenses = localStorage.getItem('budget:expenses');
        const savedTransactions = localStorage.getItem(`budget:transactions:${currentPeriod}`);
        const savedArchived = localStorage.getItem('budget:archived');
        
        if (savedIncome) setIncome(savedIncome);
        if (savedExpenses) setExpenses(JSON.parse(savedExpenses));
        if (savedTransactions) setTransactions(JSON.parse(savedTransactions));
        if (savedArchived) setArchivedMonths(JSON.parse(savedArchived));
      };

      const checkAndArchiveIfNeeded = () => {
        const lastCheck = localStorage.getItem('budget:last_check');
        const currentPeriod = getCurrentPeriod();
        
        if (lastCheck && lastCheck !== currentPeriod) {
          archiveCurrentMonth(lastCheck);
        }
        
        localStorage.setItem('budget:last_check', currentPeriod);
      };

      const archiveCurrentMonth = (period) => {
        const savedTransactions = localStorage.getItem(`budget:transactions:${period}`);
        const savedExpenses = localStorage.getItem('budget:expenses');
        const savedIncome = localStorage.getItem('budget:income');
        
        if (savedTransactions || savedExpenses || savedIncome) {
          const archived = {
            period,
            income: savedIncome || '0',
            expenses: savedExpenses ? JSON.parse(savedExpenses) : [],
            transactions: savedTransactions ? JSON.parse(savedTransactions) : [],
            archivedDate: new Date().toISOString()
          };
          
          const existing = localStorage.getItem('budget:archived');
          const existingArchive = existing ? JSON.parse(existing) : [];
          const updated = [archived, ...existingArchive];
          
          localStorage.setItem('budget:archived', JSON.stringify(updated));
          setArchivedMonths(updated);
          
          // Clear transactions for new period but keep expenses
          localStorage.removeItem(`budget:transactions:${period}`);
        }
      };

      const saveIncome = (value) => {
        setIncome(value);
        localStorage.setItem('budget:income', value);
      };

      const addExpense = () => {
        if (newExpense.name && newExpense.amount) {
          const updated = [...expenses, { id: Date.now(), ...newExpense }];
          setExpenses(updated);
          localStorage.setItem('budget:expenses', JSON.stringify(updated));
          setNewExpense({ name: '', amount: '' });
          setShowExpenseModal(false);
        }
      };

      const removeExpense = (id) => {
        const updated = expenses.filter(e => e.id !== id);
        setExpenses(updated);
        localStorage.setItem('budget:expenses', JSON.stringify(updated));
      };

      const addTransaction = () => {
        // For groceries, description is optional; for fun, it's required
        const needsDescription = newTransaction.type === 'fun';
        const isValid = newTransaction.amount && (!needsDescription || newTransaction.description);
        
        if (isValid) {
          const currentPeriod = getCurrentPeriod();
          const description = newTransaction.description || 'Groceries';
          const updated = [{ 
            id: Date.now(), 
            date: new Date().toLocaleDateString('en-GB'),
            description,
            amount: newTransaction.amount,
            type: newTransaction.type
          }, ...transactions];
          setTransactions(updated);
          localStorage.setItem(`budget:transactions:${currentPeriod}`, JSON.stringify(updated));
          setNewTransaction({ description: '', amount: '', type: 'groceries' });
          setShowTransactionModal(false);
        }
      };

      const removeTransaction = (id) => {
        const currentPeriod = getCurrentPeriod();
        const updated = transactions.filter(t => t.id !== id);
        setTransactions(updated);
        localStorage.setItem(`budget:transactions:${currentPeriod}`, JSON.stringify(updated));
      };

      const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
      const totalSpent = transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
      const remaining = parseFloat(income || 0) - totalExpenses - totalSpent;

      if (view === 'archive') {
        const yearTotal = archivedMonths.reduce((sum, month) => {
          const monthExpenses = month.expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
          const monthSpent = month.transactions.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
          const monthResult = parseFloat(month.income || 0) - monthExpenses - monthSpent;
          return sum + monthResult;
        }, 0);

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-20">
            <div className="max-w-md mx-auto">
              <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                <button
                  onClick={() => setView('current')}
                  className="flex items-center gap-2 text-indigo-600 hover:text-indigo-700 mb-4"
                >
                  <ChevronLeft size={20} />
                  Back to Current Month
                </button>
                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2 mb-4">
                  <Archive />
                  Archive
                </h1>
                
                {archivedMonths.length > 0 && (
                  <div className={`rounded-xl p-4 ${yearTotal >= 0 ? 'bg-green-100' : 'bg-red-100'}`}>
                    <div className="text-sm font-medium text-gray-700 mb-1">Total Year Savings</div>
                    <div className={`text-3xl font-bold ${yearTotal >= 0 ? 'text-green-800' : 'text-red-800'}`}>
                      {yearTotal >= 0 ? '+' : ''}€{yearTotal.toFixed(2)}
                    </div>
                  </div>
                )}
              </div>

              {archivedMonths.length === 0 ? (
                <div className="bg-white rounded-2xl shadow-lg p-6">
                  <p className="text-gray-500 text-center">No archived months yet</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {archivedMonths.map((month, index) => {
                    const monthExpenses = month.expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    const monthSpent = month.transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    const monthResult = parseFloat(month.income || 0) - monthExpenses - monthSpent;
                    
                    return (
                      <div key={index} className="bg-white rounded-2xl shadow-lg p-6">
                        <div className="flex justify-between items-start mb-3">
                          <h3 className="font-bold text-gray-800">{month.period}</h3>
                          <div className={`px-3 py-1 rounded-full ${monthResult >= 0 ? 'bg-green-100' : 'bg-red-100'}`}>
                            <span className={`text-sm font-bold ${monthResult >= 0 ? 'text-green-800' : 'text-red-800'}`}>
                              {monthResult >= 0 ? '+' : ''}€{monthResult.toFixed(2)}
                            </span>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-center mb-4">
                          <div className="bg-green-50 rounded-lg p-3">
                            <div className="text-xs text-green-700 font-medium">Income</div>
                            <div className="text-lg font-bold text-green-800">€{month.income || 0}</div>
                          </div>
                          <div className="bg-red-50 rounded-lg p-3">
                            <div className="text-xs text-red-700 font-medium">Spent</div>
                            <div className="text-lg font-bold text-red-800">€{(monthExpenses + monthSpent).toFixed(2)}</div>
                          </div>
                        </div>
                        
                        {month.expenses.length > 0 && (
                          <div className="mb-3">
                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Fixed Expenses</h4>
                            <div className="space-y-1">
                              {month.expenses.map((exp, i) => (
                                <div key={i} className="flex justify-between text-sm bg-gray-50 p-2 rounded">
                                  <span>{exp.name}</span>
                                  <span className="font-medium">€{exp.amount}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {month.transactions.length > 0 && (
                          <div>
                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Transactions ({month.transactions.length})</h4>
                            <div className="space-y-1 max-h-40 overflow-y-auto">
                              {month.transactions.map((trans, i) => (
                                <div key={i} className="flex justify-between text-sm bg-gray-50 p-2 rounded">
                                  <span>{trans.description} ({trans.date})</span>
                                  <span className="font-medium">€{trans.amount}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      }

      const weeklyTransactions = groupTransactionsByWeek();

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-20">
          <div className="max-w-md mx-auto">
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                  <DollarSign />
                  Monthly Budget
                </h1>
                <button
                  onClick={() => setView('archive')}
                  className="flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-700"
                >
                  <Archive />
                  <span className="hidden sm:inline">Archive</span>
                </button>
              </div>
              
              <div className="text-sm text-gray-600 mb-3">
                Period: {getCurrentPeriod()}
              </div>
              
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Monthly Income</label>
                <input
                  type="number"
                  value={income}
                  onChange={(e) => saveIncome(e.target.value)}
                  placeholder="Enter your income"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>

              <div className="grid grid-cols-3 gap-3 text-center">
                <div className="bg-green-50 rounded-lg p-3">
                  <div className="text-xs text-green-700 font-medium">Income</div>
                  <div className="text-lg font-bold text-green-800">€{income || 0}</div>
                </div>
                <div className="bg-red-50 rounded-lg p-3">
                  <div className="text-xs text-red-700 font-medium">Expenses</div>
                  <div className="text-lg font-bold text-red-800">€{(totalExpenses + totalSpent).toFixed(2)}</div>
                </div>
                <div className={`rounded-lg p-3 ${remaining >= 0 ? 'bg-blue-50' : 'bg-orange-50'}`}>
                  <div className={`text-xs font-medium ${remaining >= 0 ? 'text-blue-700' : 'text-orange-700'}`}>Remaining</div>
                  <div className={`text-lg font-bold ${remaining >= 0 ? 'text-blue-800' : 'text-orange-800'}`}>€{remaining.toFixed(2)}</div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div 
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setExpensesExpanded(!expensesExpanded)}
              >
                <div className="flex items-center gap-2">
                  <h2 className="text-lg font-bold text-gray-800">Fixed Expenses</h2>
                  {expenses.length > 0 && (
                    <span className="text-sm text-gray-600">(€{totalExpenses.toFixed(2)})</span>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowExpenseModal(true);
                    }}
                    className="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1 hover:bg-indigo-700"
                  >
                    <Plus size={16} /> Add
                  </button>
                  {expenses.length > 0 && (
                    expensesExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />
                  )}
                </div>
              </div>
              
              {expensesExpanded && (
                expenses.length === 0 ? (
                  <p className="text-gray-500 text-sm text-center py-4">No fixed expenses yet</p>
                ) : (
                  <div className="space-y-2 mt-4">
                    {expenses.map(expense => (
                      <div key={expense.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                        <span className="text-gray-800 font-medium">{expense.name}</span>
                        <div className="flex items-center gap-2">
                          <span className="text-gray-800 font-bold">€{expense.amount}</span>
                          <button onClick={() => removeExpense(expense.id)} className="text-red-500 hover:text-red-700">
                            <X size={18} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )
              )}
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-gray-800">Daily Spending</h2>
                <button
                  onClick={() => setShowTransactionModal(true)}
                  className="bg-green-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1 hover:bg-green-700"
                >
                  <Plus size={16} /> Log
                </button>
              </div>
              
              {transactions.length === 0 ? (
                <p className="text-gray-500 text-sm text-center py-4">No transactions yet</p>
              ) : (
                <div className="space-y-3">
                  {weeklyTransactions.map(([weekKey, week]) => {
                    const weekTotal = week.transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    const isExpanded = expandedWeeks[weekKey] !== false;
                    const shouldCollapse = week.isComplete && isExpanded;
                    
                    return (
                      <div key={weekKey} className="border border-gray-200 rounded-lg">
                        <div
                          className="flex justify-between items-center p-3 cursor-pointer hover:bg-gray-50"
                          onClick={() => setExpandedWeeks({...expandedWeeks, [weekKey]: !isExpanded})}
                        >
                          <div>
                            <div className="font-semibold text-gray-800">{week.label}</div>
                            <div className="text-sm text-gray-600">{week.transactions.length} transactions</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="font-bold text-gray-800">€{weekTotal.toFixed(2)}</span>
                            {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                          </div>
                        </div>
                        
                        {isExpanded && (
                          <div className="border-t border-gray-200 p-3 space-y-2">
                            {week.transactions.map(transaction => (
                              <div key={transaction.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                                <div>
                                  <div className="text-gray-800 font-medium">{transaction.description}</div>
                                  <div className="text-xs text-gray-500">{transaction.date} • {transaction.type}</div>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-800 font-bold">€{transaction.amount}</span>
                                  <button onClick={() => removeTransaction(transaction.id)} className="text-red-500 hover:text-red-700">
                                    <X size={18} />
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>

          {showExpenseModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-xl font-bold mb-4">Add Fixed Expense</h3>
                <input
                  type="text"
                  placeholder="Expense name (e.g., Rent)"
                  value={newExpense.name}
                  onChange={(e) => setNewExpense({...newExpense, name: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  type="number"
                  placeholder="Amount"
                  value={newExpense.amount}
                  onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500"
                />
                <div className="flex gap-2">
                  <button onClick={() => setShowExpenseModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                  </button>
                  <button onClick={addExpense} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Add
                  </button>
                </div>
              </div>
            </div>
          )}

          {showTransactionModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-xl font-bold mb-4">Log Spending</h3>
                <select
                  value={newTransaction.type}
                  onChange={(e) => setNewTransaction({...newTransaction, type: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-green-500"
                >
                  <option value="groceries">Groceries</option>
                  <option value="fun">Fun/Incidental</option>
                </select>
                <input
                  type="text"
                  placeholder="Description"
                  value={newTransaction.description}
                  onChange={(e) => setNewTransaction({...newTransaction, description: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-green-500"
                />
                <input
                  type="number"
                  placeholder="Amount"
                  value={newTransaction.amount}
                  onChange={(e) => setNewTransaction({...newTransaction, amount: e.target.value})}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-green-500"
                />
                <div className="flex gap-2">
                  <button onClick={() => setShowTransactionModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                  </button>
                  <button onClick={addTransaction} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Log
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<BudgetApp />, document.getElementById('root'));
  </script>
</body>
</html>